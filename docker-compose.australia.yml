services:
  # Next.js australia app (standalone dev)
  australia-dev:
    container_name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}-australia-dev
    build:
      context: .
      dockerfile: ./docker/Dockerfile.australia.dev
      cache_from:
        - type=registry,ref=ghcr.io/your-org/australia-dev:cache
      cache_to:
        - type=inline
    restart: unless-stopped
    network_mode: host
    environment:
      - NODE_ENV=development
      - API_PING_PATH=/health
      # Server-side API URL (direct localhost access via host networking)
      - API_URL=http://localhost:${API_PORT:-3001}
      # Client-side API URL (localhost for browser)
      - NEXT_PUBLIC_API_URL=http://localhost:${API_PORT:-3001}
      - NEXT_PUBLIC_API_PORT=${API_PORT:-3001}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_AUSTRALIA_APP_URL:-http://localhost:3010}
      - NEXT_PUBLIC_APP_PORT=${NEXT_PUBLIC_AUSTRALIA_APP_PORT:-3010}
      # Docs URL (for navbar link)
      - NEXT_PUBLIC_DOC_PORT=${NEXT_PUBLIC_DOC_PORT:-3020}
      - NEXT_PUBLIC_DOC_URL=${NEXT_PUBLIC_DOC_URL:-http://localhost:${NEXT_PUBLIC_DOC_PORT:-3020}}
      - API_ADMIN_TOKEN=${API_ADMIN_TOKEN:-secret-admin-token}
      - AUTH_SECRET=${AUTH_SECRET:-QgafJQw3O/k1gambz7YGKjtj5ZZe0dnL/WlSw4PtMDc=}
      - DEV_AUTH_KEY=${DEV_AUTH_KEY:-dev-auth-key}
      # Better Auth development features
      - BETTER_AUTH_LOG=${BETTER_AUTH_LOG:-true}
      - TELEMETRY_DISABLED=1
    volumes:
      # Mount source code for hot-reloading
      - ./apps/australia:/app/apps/australia
      - ./packages:/app/packages
      # Anonymous volumes for node_modules to avoid conflicts with host
      - /app/node_modules
      - /app/apps/australia/node_modules
      # Persistent cache volumes
      - bun_cache_australia_dev:/root/.bun/install/cache
      - turbo_cache_australia_dev:/root/.cache/turbo

volumes:
  bun_cache_australia_dev:
    name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_bun_cache_australia_dev
  turbo_cache_australia_dev:
    name: ${COMPOSE_PROJECT_NAME:-nextjs-nestjs}_turbo_cache_australia_dev
