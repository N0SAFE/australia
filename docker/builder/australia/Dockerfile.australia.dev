# syntax=docker/dockerfile:1.14

# Base stage - Install Bun and setup environment
FROM oven/bun:1.3.1-alpine AS base
RUN apk add --no-cache bash git curl openssl && \
    ln -sf $(which bun) /usr/local/bin/npm && \
    bun install -g turbo@^2 && \
    addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs
WORKDIR /app

# Pruner stage - Prepare minimal workspace
FROM base AS pruner
COPY . .
RUN --mount=type=cache,target=/root/.cache/turbo \
    bun x turbo prune australia --docker

# Installer and runner stage - Install dependencies and run dev server
FROM base AS installer-runner
# Copy pruned lockfile and package.json files
COPY --from=pruner /app/out/json/ .
COPY --from=pruner /app/out/bun.lock ./bun.lock

# Install dependencies using cache mount
RUN --mount=type=cache,target=/root/.bun/install/cache \
    bun ci --verbose

# Copy pruned source files
COPY --from=pruner /app/out/full/ .

# Generate ORPC types and build dependencies at image build time (not at container start)
# This ensures dependencies are ready when dev server starts
RUN --mount=type=cache,target=/root/.cache/turbo \
    bun x turbo run generate --filter=australia

# Create .next directory with proper permissions for the nextjs user
RUN mkdir -p apps/australia/.next && \
    chown -R nextjs:nodejs apps/australia/.next && \
    chown -R nextjs:nodejs /app

# Switch to nextjs user
USER nextjs

# Expose the australia app port
EXPOSE 3010

# Run the Next.js development server
CMD ["bun", "x", "turbo", "run", "dev", "--filter=australia"]
